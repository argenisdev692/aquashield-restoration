import * as React from 'react';
import { Head, Link, router, usePage } from '@inertiajs/react';
import AppLayout from '@/Pages/layouts/AppLayout';
import { useSingleCompanyData } from '@/modules/company-data/hooks/useCompanyData';
import { useUpdateCompanyData } from '@/modules/company-data/hooks/useCompanyDataMutations';
import type { UpdateCompanyDataDTO } from '@/types/api';
import type { PageProps } from '@inertiajs/core';

// ══════════════════════════════════════════════════════════════
// Icons
// ══════════════════════════════════════════════════════════════
const ic = {
  w: 16, h: 16, viewBox: '0 0 24 24', fill: 'none',
  stroke: 'currentColor', strokeWidth: 2,
  strokeLinecap: 'round' as const, strokeLinejoin: 'round' as const,
};
const IconArrowLeft = () => <svg {...ic}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>;
const IconSave = () => <svg {...ic}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;

// ══════════════════════════════════════════════════════════════
// CompanyDataEditPage
// ══════════════════════════════════════════════════════════════
export default function CompanyDataEditPage(): React.JSX.Element {
  const { props } = usePage<PageProps & { companyId: string }>();
  const uuid = props.companyId; // We need to ensure the backend passes 'companyId' -> maybe we grab it from URL?
  
  // Extract uuid from url if inertia prop doesn't supply it
  const urlParts = window.location.pathname.split('/');
  const finalUuid = uuid || urlParts[urlParts.length - 2]; 

  const { data: company, isPending, isError } = useSingleCompanyData(finalUuid);
  const updateMutation = useUpdateCompanyData();

  const [formData, setFormData] = React.useState<UpdateCompanyDataDTO>({});

  // Sync fetched data into local state once
  React.useEffect(() => {
    if (company) {
      setFormData({
        company_name: company.company_name,
        name: company.name,
        email: company.email,
        phone: company.phone,
        address: company.address,
        website: company.website,
        facebook_link: company.facebook_link,
        instagram_link: company.instagram_link,
        linkedin_link: company.linkedin_link,
        twitter_link: company.twitter_link,
      });
    }
  }, [company]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    updateMutation.mutate({ uuid: finalUuid, payload: formData }, {
      onSuccess: () => {
        router.visit('/company-data');
      },
      onError: (error) => {
        console.error('Failed to update company data:', error);
        alert('Failed to save company data. Please check the console.');
      }
    });
  };

  if (isPending) {
    return (
      <AppLayout>
        <div className="flex h-[50vh] items-center justify-center">
          <p style={{ color: 'var(--text-muted)' }}>Loading company data...</p>
        </div>
      </AppLayout>
    );
  }

  if (isError || !company) {
    return (
      <AppLayout>
        <div className="flex h-[50vh] items-center justify-center">
          <p style={{ color: 'var(--accent-error)' }}>Failed to load company profile.</p>
        </div>
      </AppLayout>
    );
  }

  return (
    <AppLayout>
      <Head title={`Edit ${company.company_name}`} />
      <div style={{ fontFamily: 'var(--font-sans)', maxWidth: '800px', margin: '0 auto' }}>
        
        {/* ── Header ── */}
        <div className="mb-6 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link
              href="/company-data"
              className="flex h-9 w-9 items-center justify-center rounded-lg transition-all hover:bg-(--bg-hover)"
              style={{ color: 'var(--text-muted)' }}
            >
              <IconArrowLeft />
            </Link>
            <div>
              <h1 className="text-xl font-bold tracking-tight" style={{ color: 'var(--text-primary)' }}>
                Edit {company.company_name}
              </h1>
              <p className="text-xs mt-1" style={{ color: 'var(--text-muted)' }}>
                Update the official corporate information below.
              </p>
            </div>
          </div>
          <button
            onClick={handleSubmit}
            disabled={updateMutation.isPending}
            className="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all disabled:opacity-50"
            style={{
              background: 'var(--accent-primary)',
              color: 'var(--color-white)',
            }}
          >
            {updateMutation.isPending ? 'Saving...' : <><IconSave /> Save Changes</>}
          </button>
        </div>

        {/* ── Form Card ── */}
        <div className="card">
          <form onSubmit={handleSubmit} className="space-y-6">
            
            <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
              {/* Company Name */}
              <div>
                <label className="input-label" htmlFor="company_name">Company Name *</label>
                <input
                  id="company_name"
                  name="company_name"
                  type="text"
                  required
                  value={formData.company_name || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="e.g. Acme Corp"
                />
              </div>

              {/* Representative Name */}
              <div>
                <label className="input-label" htmlFor="name">Representative Name</label>
                <input
                  id="name"
                  name="name"
                  type="text"
                  value={formData.name || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="e.g. Jane Doe"
                />
              </div>

              {/* Email */}
              <div>
                <label className="input-label" htmlFor="email">Contact Email</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  value={formData.email || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="contact@acmecorp.com"
                />
              </div>

              {/* Phone */}
              <div>
                <label className="input-label" htmlFor="phone">Phone Number</label>
                <input
                  id="phone"
                  name="phone"
                  type="text"
                  value={formData.phone || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="+1 (555) 000-0000"
                />
              </div>
              
              {/* Website */}
              <div className="md:col-span-2">
                <label className="input-label" htmlFor="website">Website URL</label>
                <input
                  id="website"
                  name="website"
                  type="url"
                  value={formData.website || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="https://www.acmecorp.com"
                />
              </div>

              {/* Address */}
              <div className="md:col-span-2">
                <label className="input-label" htmlFor="address">Address</label>
                <textarea
                  id="address"
                  name="address"
                  rows={3}
                  value={formData.address || ''}
                  onChange={handleChange}
                  className="input h-auto! pt-2"
                  placeholder="123 Corporate Blvd, Suite 100..."
                />
              </div>
            </div>

            <hr style={{ borderColor: 'var(--border-subtle)', margin: '24px 0' }} />

            <h3 className="mb-4 text-sm font-semibold" style={{ color: 'var(--text-secondary)' }}>
              Social Links
            </h3>

            <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
              <div>
                <label className="input-label" htmlFor="linkedin_link">LinkedIn</label>
                <input
                  id="linkedin_link"
                  name="linkedin_link"
                  type="url"
                  value={formData.linkedin_link || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="https://linkedin.com/company/acmecorp"
                />
              </div>
              <div>
                <label className="input-label" htmlFor="twitter_link">Twitter (X)</label>
                <input
                  id="twitter_link"
                  name="twitter_link"
                  type="url"
                  value={formData.twitter_link || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="https://twitter.com/acmecorp"
                />
              </div>
              <div>
                <label className="input-label" htmlFor="facebook_link">Facebook</label>
                <input
                  id="facebook_link"
                  name="facebook_link"
                  type="url"
                  value={formData.facebook_link || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="https://facebook.com/acmecorp"
                />
              </div>
              <div>
                <label className="input-label" htmlFor="instagram_link">Instagram</label>
                <input
                  id="instagram_link"
                  name="instagram_link"
                  type="url"
                  value={formData.instagram_link || ''}
                  onChange={handleChange}
                  className="input"
                  placeholder="https://instagram.com/acmecorp"
                />
              </div>
            </div>

          </form>
        </div>
      </div>
    </AppLayout>
  );
}
